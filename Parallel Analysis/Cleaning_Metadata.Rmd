---
title: "Database Clean"
author: "Juliano Palacios Abrantes"
date: "11/22/2017"
output: html_document
---

The following script will be used to explore and clean the final metadata. I'm searching for any type of errors and will go column by column.

- First modification on Template_5 on November 22


```{r Setup, echo= T, eval= F}

# Libraries 

ipak <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg)) 
    install.packages(new.pkg, dependencies = TRUE)
  sapply(pkg, require, character.only = TRUE)
}


#### Library ####
packages <- c(
  "dplyr",
  "tidyr",
  "knitr",
  "data.table",
  "hunspell" #For spelling check in english
              )

ipak(packages)


#Dataset

# Template <- read.csv("~/Documents/Dropbox/Metadata_Mexico/English/Templates/Template_5.2.csv")


#### NOTE ####
# RUN EVERYTIME YOU FINISH

write.csv(Fized,
          "Template_5.3B.csv",
          row.names = FALSE)

```


```{r Useful_Codes, echo= T, eval= F}



#### Usefull codes ####


#### Changing Words ###
# Only one column
Template_5.2$Keywords <- gsub( 
  "", #Word you want to change
  " ", #New Word
  Template_5.2$Keywords)

#All Columns #

Templatebb <- data.frame(lapply(Templateb, function(x) {
  gsub("Swath Surveys", #Word you want to change
       "Quadrat Surveys", #New Word
       x)
}))

" Remove unwanted characters"
chartr("áéíóúñ", "aeioun", dataMares_Metadata)

```

## General Corrections

This chunk corrected the following mistakes:

### Duplicated rows

These are the repositories that had duplicated rows (Title | n repeated | Initial MMID | Final MMID ): 

- Tendencias de Captura de tiburon en el sureste de Mexico y caracterizacion de sus mercados	30	96385	100723
- Base de Datos Oceanograficos Proyectados del golfo de california 5 60949 60958
- Gulf of Mexico Species Interactions	1	35235	35235
- Global Biodiversity Information Facility 13000	68500	82157
- Datos Abiertos MX	2	83951	83956
- Datos Abiertos MX	102	83304	83759
- World Data Base of Marine Protected Areas 56	60308	60674

Observacion: 
- Datos Abiertos MX	102	83304	83759. Stays because is the same title but each row is a different species

### Characters

I've sorted all unwanted characters (áé...ñ) from the meta-database

```{r General_corrections, echo= T, eval= F}

# DO NOT RUN #

# It will look for rows that are identical

Repeated_Template <-Template[duplicated(Template[2:length(Template)]), ] # Ignoring MMID because thatone will not be repeated

### NOTE: ####
# Since Template_5.2 there should be 102 repeated observations 

Repeated_Bases <- Repeated_Template %>% 
  group_by(
           Dataset_Title,
           Compilation_Title) %>% 
  summarise(n(),
            Min=min(MMID),
            Max=max(MMID)
  )
  
### Testing #
x <- Template %>% 
  filter(Short_Title == "Beneficiarios de Programa de Modernizacion de Flota Mayor en Yucatan (2012 - 2015)")

Modernos <- Template %>% 
  filter(Dataset_Title == "Base de Datos Oceanograficos Proyectados del golfo de california")


### Clear the Dataset ####

# Remove Repeated Values

# First we filter-out the dataset that is duplicated but correct
Template_Embar <- Template %>% 
  filter(Dataset_Title != "Tabla de solicitudes ingresadas para sustitucion de motores por municipio") 

# Now we remove the duplicated rows from the rest of the metadata
No_Duplicated <- Template_Embar[!duplicated(Template_Embar[2:length(Template_Embar)]), ]

# Finally we join them back together...
Clear_Template <- Template %>% 
  filter(Dataset_Title == "Tabla de solicitudes ingresadas para sustitucion de motores por municipio") %>% 
  bind_rows(No_Duplicated) %>% 
  arrange(MMID)

# Aaaaaaaand, we Fix the MMID order....

Clear_Template$MMID <- seq(1,nrow(Clear_Template))

# Now we check everything is OK, there should be only 102 duplicated ones
Double_Chek <-Clear_Template[duplicated(Clear_Template[2:length(Clear_Template)]), ] 

 #unique(Double_Chek$Dataset_Title)

#All es gut we save it...

write.csv(Clear_Template,
          "Template_5.1.csv",
          row.names = FALSE)

### END _________________________________________________________________#

#### NOTE ####
knitr::kable(Repeated_Bases,
             caption = "Duplicated Records within Compilations")


```



## Short_Title

All entries in `Short_Title` were changed so the first letter of each word is capitalize (e.j. "Historic Catch of Wild Lisa in Mexico") this will improve consistency but will bring all species names to both upper cases. 

```{r Short_Title, eval =F, echo =T}

# As character
Template$Short_Title <- as.character(Template$Short_Title)

# All entreies should be in the following format (Excel Proper):
"La Pesca Ilegal En Mexico"
# So we borrow this function
# https://stackoverflow.com/questions/6364783/capitalize-the-first-letter-of-both-words-in-a-two-word-string

simpleCap <- function(x) {
  s <- strsplit(x, " ")[[1]]
  paste(toupper(substring(s, 1,1)), substring(s, 2),
        sep="", collapse=" ")
}

# And then we run it for this column
Template$Short_Title<- lapply(Template$Short_Title,
                               simpleCap
                               )

# Now we remove the capital for articles

Template$Short_Title <-Template$Short_Title %>% 
  # First English
  gsub("For ","for ",.) %>% 
  gsub("Of ","of ",.) %>% 
  gsub("And ","and ",.) %>% 
  gsub("In ","in ",.) %>% 
  gsub("On ","on ",.) %>% 
  gsub("The ","the ",.) %>% 
  # And now Spanish
  gsub("El ","el ",.) %>% 
  gsub("La ","la ",.) %>% 
  gsub("Las ","la ",.) %>% 
  gsub("Los ","los ",.) %>% 
  gsub("Y ","y ",.) %>% 
  gsub("En ","en ",.) %>% 
  gsub("De ","de ",.) %>% 
  gsub("Del ","del ",.)

# NOTE: 
# Species names will be both capitalized.

# Manually correct them (beacuase of spanish)
Template$Short_Title <-Template$Short_Title %>% 
  # First English
  gsub(" de de ","de ",.)

```


## Keywords

The only changes for `Keywords` was bringing all first letter to capital letters, removing double spaces and changing "," for ";"
```{r Keywords, ecal =F, echo =T}

# Keywords ####

Template$Keywords <- as.character(Template$Keywords)

Template$Keywords<- lapply(Template$Keywords,
                               simpleCap
                               )

# Now we remove the capital for articles

Template$Keywords <-Template$Keywords %>% 
  # gsub(",",";",.) %>%  # , for ; 
  # gsub("  "," ",.) %>% #double spaces
  gsub("checklist","Listado",.) #Translations


```


## Author

All records under `Author` have been standarized to Lastname Initial(s) (e.j. Walters, C.J.)

```{r Author, eval =T, echo =T}

Authors <- Template_5.3 %>% 
  group_by(Author) %>% 
  summarise(n())

# Corrections
Template_5.2$Author[min(Guat$MMID):max(Guat$MMID)] <- gsub( 
  "NA", #Word you want to change
  "USGS", #New Word
  Template_5.2$Author[min(Guat$MMID):min(Guat$MMID)])


Guat <- Reomve %>% 
  filter(is.na(Author)) %>% 
  filter(MMID == 637 | MMID == 41314)

Guat$Author <- c("CONABIO","USGS")

Fixed <- Template_5.3 %>% 
  filter(is.na(Author)) %>% 
  bind_rows(Guat)


Not <- Template_5.2 %>% 
  anti_join(Template_5.3,
            by ="MMID") %>% 
  filter(MMID == 637)

Fized <- Template_5.3 %>% 
  bind_rows(Not)




```












































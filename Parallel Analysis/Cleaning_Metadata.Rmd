---
title: "Database Clean"
author: "Juliano Palacios Abrantes"
date: "11/22/2017"
output: html_document
---

The following script will be used to explore and clean the final metadata. I'm searching for any type of errors and will go column by column.

- First modification on Template_5 on November 22
- Second modification on Template_5 on November 27 (5.3)
- Third modification on Template_5 on November 28 (5.5) With subject names


```{r Setup, echo= T, eval= F}

# Libraries 

ipak <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg)) 
    install.packages(new.pkg, dependencies = TRUE)
  sapply(pkg, require, character.only = TRUE)
}


#### Library ####
packages <- c(
  "dplyr",
  "tidyr",
  "knitr",
  "data.table",
  "hunspell",#For spelling check in english
  "stringr", # For finding string in column
  "taxize", # For species scientific name
  "tools" #For upper/lowwer letters
  )

ipak(packages)

#Dataset

Template <- read.csv("~/Documents/Dropbox/Metadata_Mexico/English/Templates/Template_6.8.csv")


#### NOTE ####
# RUN EVERYTIME YOU FINISH

# write.csv(Template,
#           "Template_6.1.csv",
          # row.names = FALSE)

# Tremplate_5.3 until Subject_name





```


```{r Useful_Codes, echo= T, eval= F}



#### Usefull codes ####


#### Changing Words ###
# Only one column
Template_5.2$Keywords <- gsub( 
  "", #Word you want to change
  " ", #New Word
  Template_5.2$Keywords)

#All Columns #

Templatebb <- data.frame(lapply(Templateb, function(x) {
  gsub("Swath Surveys", #Word you want to change
       "Quadrat Surveys", #New Word
       x)
}))

" Remove unwanted characters"
chartr("áéíóúñ", "aeioun", dataMares_Metadata)


# Use \b to indicate a word boundary <-  "\\bsp\\b"
# Use to eliminate/replace everything after a "," <-  ",.*"
# Use to eliminate/replace everything within parenthesis <- " *\\(.*?\\) *"
# Punctual Corrections
Sci_Correct_75$user_supplied_name<- gsub( 
  "\\bsp\\b", #Word you want to change
  "", #New Word
  Sci_Correct_75$user_supplied_name)



```

## General Corrections

This chunk corrected the following mistakes:

### Duplicated rows

These are the repositories that had duplicated rows (Title | n repeated | Initial MMID | Final MMID ): 

- Tendencias de Captura de tiburon en el sureste de Mexico y caracterizacion de sus mercados	30	96385	100723
- Base de Datos Oceanograficos Proyectados del golfo de california 5 60949 60958
- Gulf of Mexico Species Interactions	1	35235	35235
- Global Biodiversity Information Facility 13000	68500	82157
- Datos Abiertos MX	2	83951	83956
- Datos Abiertos MX	102	83304	83759
- World Data Base of Marine Protected Areas 56	60308	60674

Observacion: 
- Datos Abiertos MX	102	83304	83759. Stays because is the same title but each row is a different species
- Since Template_5.2 there should be 102 repeated observations 
- Since Template_5.2_4 there should be 109 repeated observations because some of the categories were merged (e.g. "Camaron sin cabeza"" and "Camaron con cabeza" became "Camaron")

### Characters

I've sorted all unwanted characters (áé...ñ) from the meta-database

```{r General_corrections, echo= T, eval= F}

# DO NOT RUN #

# It will look for rows that are identical

Repeated_Template <-Template[duplicated(Template[2:length(Template)]), ] # Ignoring MMID because thatone will not be repeated
Non_Repeated_Template <-Template[!duplicated(Template[2:length(Template)]), ] # dropping repeated
Check_Repeated_Template <-Non_Repeated_Template[duplicated(Non_Repeated_Template[2:length(Non_Repeated_Template)]), ] # Ignoring MMID because thatone will not be repeated

# write.csv(Non_Repeated_Template,
#           "Template_6.2.csv",
#           row.names = F)



Repeated_Bases <- Repeated_Template %>% 
  group_by(
           Dataset_Title,
           Compilation_Title) %>% 
  summarise(n(),
            Min=min(MMID),
            Max=max(MMID)
  )
  
### Testing #
x <- Template %>% 
  filter(Short_Title == "Beneficiarios de Programa de Modernizacion de Flota Mayor en Yucatan (2012 - 2015)")

Modernos <- Template %>% 
  filter(Dataset_Title == "Base de Datos Oceanograficos Proyectados del golfo de california")


### Clear the Dataset ####

# Remove Repeated Values

# First we filter-out the dataset that is duplicated but correct
Template_Embar <- Template %>% 
  filter(Dataset_Title != "Tabla de solicitudes ingresadas para sustitucion de motores por municipio") 

# Now we remove the duplicated rows from the rest of the metadata
No_Duplicated <- Template_Embar[!duplicated(Template_Embar[2:length(Template_Embar)]), ]

# Finally we join them back together...
Clear_Template <- Template %>% 
  filter(Dataset_Title == "Tabla de solicitudes ingresadas para sustitucion de motores por municipio") %>% 
  bind_rows(No_Duplicated) %>% 
  arrange(MMID)

# Aaaaaaaand, we Fix the MMID order....

Clear_Template$MMID <- seq(1,nrow(Clear_Template))

# Now we check everything is OK, there should be only 102 duplicated ones
Double_Chek <-Clear_Template[duplicated(Clear_Template[2:length(Clear_Template)]), ] 

 #unique(Double_Chek$Dataset_Title)

#All es gut we save it...

# write.csv(Clear_Template,
#           "Template_5.1.csv",
#           row.names = FALSE)

### END _________________________________________________________________#

#### NOTE ####
knitr::kable(Repeated_Bases,
             caption = "Duplicated Records within Compilations")


#### ELIMINATE ROWS ####
# Not yet removed...

#MMIDs:
# 59554
# 59555


```



## Short_Title

All entries in `Short_Title` were changed so the first letter of each word is capitalize (e.j. "Historic Catch of Wild Lisa in Mexico") this will improve consistency but will bring all species names to both upper cases. 

```{r Short_Title, eval =F, echo =T}

# As character
Template$Short_Title <- as.character(Template$Short_Title)

# All entreies should be in the following format (Excel Proper):
"La Pesca Ilegal En Mexico"
# So we borrow this function
# https://stackoverflow.com/questions/6364783/capitalize-the-first-letter-of-both-words-in-a-two-word-string

#New modern version


# library(tools)
toTitleCase("demonstrating the title case")


# Old version


simpleCap <- function(x) {
  s <- strsplit(x, " ")[[1]]
  paste(toupper(substring(s, 1,1)), substring(s, 2),
        sep="", collapse=" ")
}

# And then we run it for this column
Template$Short_Title<- lapply(Template$Short_Title,
                               simpleCap
                               )

# Now we remove the capital for articles

Template$Location <-Template$Location %>% 
  # First English
  gsub(" For "," for ",.) %>% 
  gsub(" Of "," of ",.) %>% 
  gsub(" And "," and ",.) %>% 
  gsub(" In "," in ",.) %>% 
  gsub(" On "," on ",.) %>% 
  gsub(" The "," the ",.) %>% 
  # And now Spanish
  gsub(" El "," el ",.) %>% 
  gsub(" La "," la ",.) %>% 
  gsub(" Las "," la ",.) %>% 
  gsub(" Los "," los ",.) %>% 
  gsub(" Y "," y ",.) %>% 
  gsub(" En "," en ",.) %>% 
  gsub(" De "," de ",.) %>% 
  gsub(" Del "," del ",.)

# NOTE: 
# Species names will be both capitalized.


# Only first letter capitalized in EXCEL

# =UPPER(LEFT(A2,1))&LOWER(RIGHT(A2,LEN(A2)-1))


# Manually correct them (beacuase of spanish)
Template$Short_Title <-Template$Short_Title %>% 
  # First English
  gsub(" de de ","de ",.)

### Specific changes #

Template$Short_Title <-Template$Short_Title %>% 
  gsub("Iucn ","IUCN ",.)

```


## Keywords

The only changes for `Keywords` was bringing all first letter to capital letters, removing double spaces and changing "," for ";"
```{r Keywords, ecal =F, echo =T}

# Keywords ####

Template$Keywords <- as.character(Template$Keywords)

Template$Keywords<- lapply(Template$Keywords,
                               simpleCap
                               )

# Now we remove the capital for articles

Template$Keywords <-Template$Keywords %>% 
  # gsub(",",";",.) %>%  # , for ; 
  # gsub("  "," ",.) %>% #double spaces
  gsub("checklist","Listado",.) #Translations


```


## Author

All records under `Author` have been standarized to Lastname Initial(s) (e.j. Walters, C.J.) and "-" have been removed.

```{r Author, eval =T, echo =T}

Authors <- Template %>% 
  group_by(Author) %>% 
  summarise(n())

# Corrections
Template$Author<- gsub( 
  "UNEP WCMC", #Word you want to change
  "UNEP-WCMC", #New Word
  Template$Author)

Author_Explore <- Template %>% 
  filter(Author == "DSC_RTP")

head(Author_Explore)

Author_Explore$Reference[1]
  

```


## Institution

All records under `Institution` have been standarized to University-Facutluy (e.j. UNAM-ICMyL)

```{r Institutions, eval =T, echo =T}

Institutions <- Template %>% 
  group_by(Institution) %>% 
  summarise(n())

# Corrections
Template$Institution<- gsub( 
  "UNIATMOS-UNAM", #Word you want to change
  "UNAM-UNIATMOS", #New Word
  Template$Institution)

Institution_Explore <- Template %>% 
  filter(Institution == "CINVESTAV")

head(Institution_Explore)

Institution_Explore$Reference[1]

# Dealing with the two NA's

Institutions_NA <- Template %>% 
  filter(is.na(Institution))

# Nevermind, we actually don't have that information...

Author_Institutions <- Template %>% 
  group_by(Institution,
           Author) %>% 
  summarise(n())

#All es gut! 
  
```

## Dataset_Available

```{r Dataset_Available, eval =T, echo =T}

#Checking if they are all 1,2 or 3... 
unique(Template$Dataset_Available)

#... not

length(unique(Template$Dataset_Available))

#### Fixing the whole #

Wrong <- Template %>% 
  filter(Dataset_Available >= 4) %>% 
  mutate(Dataset_Availableb = 1) %>% 
  select(-Dataset_Available) %>% 
  select(1:5,Dataset_Availableb,everything()) %>% 
  rename(Dataset_Available = Dataset_Availableb)

Templateb <- Template %>% 
  filter(Dataset_Available <= 3) %>% 
  bind_rows(Wrong) %>% 
  arrange(MMID)

# GOC were excluded because they did not have a number... 
Excluded <- Template %>% 
  anti_join(Templateb,
            by="MMID") %>% 
  mutate(Dataset_Availableb = 2) %>% 
  select(-Dataset_Available) %>% 
  select(1:5,Dataset_Availableb,everything()) %>% 
  rename(Dataset_Available = Dataset_Availableb) %>% 
  bind_rows(Templateb) %>% 
  arrange(MMID)

Template <- Excluded

# Now go back and re-check

#All es gut! 


```



## Subject_name

This will probably be the most intesive-fix of all. Things to do:
 
- Check all common names are in spanish
- Check all common names are well spelled
- Check all scientific names are well spelled
  + No Authors included
- Standarize categories (e.j. Multiple Species, Species Multiple, Many Species, etc)
  + Multiple species
  + Remove "s" from common names
  + Arrecife y corales
- Remove non-species
- Solved for FAO's "Tbd"s
- Translate names to spanish

```{r Subject_name, eval =T, echo =T}

# Exploration
Subjects <- Template %>% 
  group_by(Subject_name) %>% 
  summarise(n())


# - Standarize categories (e.j. Multiple Species, Species Multiple, Many Species, etc)
# Multiple
Specific <- Subjects %>% 
  filter(str_detect(Subject_name, 'Multiple')
  )

# Arrecife y corales
Specific <- Subjects %>% 
  filter(str_detect(Subject_name, 'Coral')
  )

# Common names

# Filter all names that do not have more than one word
Comn <- Subjects %>% 
  filter(!str_detect(Subject_name, ' ')
  )

# Plural to singular ("s")
Plurals <- data.frame(Plural_Names = grepl("^.+(s)$",Comn$Subject_name)) %>%  #Finds all strings ending with "s"
  bind_cols(Comn) %>% 
  filter(Plural_Names == TRUE)

# Fin del editado de nombres comunes

# Sci names
Sci <- Template %>% 
  group_by(Subject_name) %>% 
  summarise(n()) %>% 
  filter(str_detect(Subject_name, ' ')
  ) 

# Remove text within parenthesis for betteer species catalogue
Sci$Subject_name <- gsub( " *\\(.*?\\) *", "", 
                               Sci$Subject_name)

# Now, we will use taxzise to correct scientific names

Sci_Correct <- gnr_resolve(names = Sci$Subject_name, #Looks for homogenic names 
                           best_match_only = TRUE, # Will only give us the best match
                           canonical = TRUE #Removes names
                           )

# How many from each score...

Scores <- Sci_Correct %>% 
  group_by(score) %>% 
  summarise(n())

# Good, most of them are over 95...

# Filtering those that are correct or were corrected
Sci_Correct_90 <- Sci_Correct %>% 
  filter(score >= 0.90) %>% # Select good ones
  select(user_supplied_name,
         matched_name2) %>% 
  rename(Subject_name = user_supplied_name) %>% 
  left_join(Template,
            by="Subject_name") %>% # Join both datasets by the original name
  select(-Subject_name) %>% #Remove old (original) column 
  select(2:7,matched_name2,everything()) %>% # Select the new (corrected) subject names
  rename(Subject_name = matched_name2) # rename it

#Done 

#Now those that are under 95% confidence
  
Sci_Correct_75 <- Sci_Correct %>% 
  filter(score <= 0.80)

# First lets take out those that were "somehow" ok

Sci_Correct_75_Similar_Metadata <- Sci_Correct_75 %>%  # Original ones
  filter(score <= 0.80) %>% 
  select(user_supplied_name) %>% 
  rename(matched_name2 = user_supplied_name)

Sci_Correct_75_Similar_Matched <- Sci_Correct_75 %>% # Newones ones
  filter(score <= 0.80) %>% 
  select(matched_name2)

Sci_Correct_75_Similars <-Sci_Correct_75_Similar_Metadata %>% #Those that are the same (Only 12)
  semi_join(Sci_Correct_75_Similar_Matched,
            by = "matched_name2")

#Lets join both the over 90% and the 12 that are correct together

#### THE MOST COMPLETED DATABASE ####
Sci_Correct_75_A <- Template %>% 
  filter(Subject_name %in% Sci_Correct_75_Similars$matched_name2) %>% 
  bind_rows(Sci_Correct_90)

# Now we add the other names but leave the originals in the "NOTE column"

Final_Sci_Correct_75 <- Template %>% 
  filter(Subject_name %in% Sci_Incorrect_75$Subject_name) %>% #Filter from the template those names under 75%
  left_join(Sci_Incorrect_75, #Bring the corrected names
            by="Subject_name") %>% 
  select(-Notes,-Sci) %>% #Remove Note and "Sci"
  rename(Notes = Subject_name, #Rename the old categories as Notes
         Subject_name = matched_name2) %>% # Bring in the new names (corrected) as Subject_name
  select(1:6,31,8:27,Notes,everything()) #rearrenge

# Now we add scientific and common...

All_Scientific <- Sci_Correct_75_A %>%  #All scientific names
  bind_rows(Final_Sci_Correct_75)
  
NON_Sci_Temp <- Template %>% #Selecting all rows not in scientific names
  anti_join(All_Scientific,
            by ="MMID")

# And now technically this should be the same size as "Template"

Final_Corrected_Names <- Sci_Correct_75_A %>% 
  bind_rows(Final_Sci_Correct_75) %>% 
  bind_rows(NON_Sci_Temp) %>% 
  arrange(MMID)

# It is... is it the same, thou?

Test <- Final_Corrected_Names %>% 
  anti_join(Template,
            by="MMID")

#MMID: 0 match, they are all the same!!!!!!
#Short_title: 0 match, they are all the same!!!!!!
# 1196 names corrected

# and repeats?

# NO repeats!!! 
#________________________________________#

## Fixing the Tbd (FAO from english to scientific) ####

# Select specific species
TBD <- Template %>% 
  filter(Subject_name == "Tbd") %>% 
  select(MMID,
         Short_Title) %>% 
  mutate(TBD_Original = paste(Short_Title))

# Remove short title to have only common names
TBD$Short_Title<- TBD$Short_Title %>% 
  gsub("Catch of ", "",.) %>% 
  gsub(" Nei", "",.) %>% 
  gsub("Aquaculture Production of Marine ", "",.) %>% 
  gsub("Aquaculture Production of Freshwater ", "",.) %>%
  gsub("Aquaculture Production of Brackishwater ", "",.) %>%
  gsub("Production and Trade of Marine ", "",.) %>%
  gsub("Production and Trade of Freshwater ", "",.) %>%
  gsub("Production and Trade of ", "",.) %>%
  gsub("Aquaculture Production Value of Freshwater ", "",.) %>% 
  gsub("Aquaculture Production Value of Brackishwater ", "",.) %>% 
  gsub("Aquaculture Production Value of Marine ", "",.) %>% 
  gsub(",.*", "",.) %>% 
  gsub(" *\\(.*?\\) *", "",.) %>% 
  gsub(" Meat", "",.) %>% 
  gsub(" and.*", "",.)

# Manualy change some of them that are beign anoying

TBD$Short_Title [313]<- "Euthynnus"

# Now we retrieve the scientific names available from the list using taxsize
Fixed_Names <- comm2sci(TBD$Short_Title,
                          db="worms",
                          # itisby = "search",
                          simplify= TRUE
                          )

# Put it on a nice dataframe
Sci_Name <- data.frame(Corrected = sapply(Fixed_Names, function(x){paste(x[1])}))
                       
# Now we incorporate the new names to the old data 

Fixed_TBD <- TBD %>% 
  bind_cols(Sci_Name)

# Fix the NA problem

Fixed_TBA_NA <- Fixed_TBD %>% 
  filter(Corrected == "NA") %>% 
  select(MMID,Short_Title) %>% 
  dplyr::rename(Corrected = Short_Title) %>% 
  mutate(Old_Subject = paste(Corrected))

# Now we translate those that the system did not liked... Hell no... Just do it on Excel "bruh!!"

FAO_Translated <- read.csv("~/Desktop/FAO_Translated.csv")


Fixed_TBD_Final <- Fixed_TBD %>% 
  filter(Corrected != "NA") %>% 
  select(-TBD_Original) %>% 
  dplyr::rename(Old_Subject = Short_Title) %>% 
  bind_rows(FAO_Translated) %>% 
  arrange(MMID)

# Fixed and translated! 


# Extra solve short title problem #

# Now we incorporate the 
Final_TBD <- Fixed_TBD_Final %>% 
  left_join(Template,
            by="MMID") %>% 
  select(-Subject_name,
         -Notes,
         -Sci) %>% 
  select(
    1,4:8,Corrected,10:29,Old_Subject,everything()
  ) %>% 
  dplyr::rename(Subject_name = Corrected) %>% 
  dplyr::rename(Notes = Old_Subject)

# And now merge to the Template

New_Template <- Template %>% 
  filter(Subject_name != "Tbd") %>% 
  bind_rows(Final_TBD) %>% 
  arrange(MMID) %>% 
  select(-Sci)

# Take out non-species names... ####


#### Fish Base cleaning ####
Especies_CNP <- read.csv("~/Documents/Dropbox/Metadata_Mexico/Datasets/CartaNac.Pesq/Especies_CNP.csv") %>% 
  rename(Subject_name = Cientifico)

FishBase <- Template %>% 
  filter(C_ID == 56) %>% 
  semi_join(Especies_CNP,
            by="Subject_name")


EcoFishBase <- Template %>% 
  filter(C_ID == 56) %>% 
  anti_join(Especies_CNP,
            by="Subject_name") %>% 
  select(-Research_Field) %>% 
  mutate(Research_Field = "Ecology") %>% 
  select(1:25,Research_Field,everything()) %>% 
  bind_rows(FishBase)
  
New_template <- Template %>%
  filter(C_ID != 56) %>% 
  bind_rows(EcoFishBase) %>% 
  arrange(MMID)

# write.csv(New_template,
#           "Template_6.8.csv",
#           row.names = FALSE)


```


## Area, region

- Fixed some of the missspells in the categories 
- Filled missing cattegories
- There are many TBDs waiting for Marcia Moreno's data

```{r Area, eval =T, echo =T}

#### Area ####

Area_Explore <- Template %>% 
  group_by(Area) %>% 
  dplyr::summarise(n()) 

# Some NA's

Area_NA <- Template %>% 
  filter(is.na(Area))%>% 
  select(MMID,
         Short_Title,
         Area,
         Region,
         Location)

# Get all those NAs

Nas <- Template %>% 
  filter(MMID >= 68567 & MMID <=68649) %>% 
   select(MMID,
         Short_Title,
         Area,
         Region,
         Location) 

#### Region ####

Region_Explore <- Template %>% 
  group_by(Region) %>% 
  dplyr::summarise(n())


#### Corrections #

# Corrections
Template$Region<- gsub( 
  "Sopa", #Word you want to change
  "W.G. Mexico", #New Word
  Template$Region)

View(Template)


#### OBIS TBDS ####

TBDS <- Template %>% 
  filter(Region =="TBD")

BCC <- Template %>% 
  filter(Region =="TBD") %>% 
  filter(Long >= -92.488283) %>% 
  select(-Region) %>% 
  mutate(Region = "B. Camp. Caribe") %>% 
  select(1:10,Region,everything())

WGM <- Template %>% 
  filter(Region =="TBD") %>% 
  filter(Long <= -92.488283 & Long >= -98.242770,
         Lat >= 18.091205) %>% 
  select(-Region) %>% 
  mutate(Region = "W. G. Mexico") %>% 
  select(1:10,Region,everything())

SP <- Template %>% 
  filter(Region =="TBD") %>% 
  filter(Lat <= 16.315368 & Long >= -98.552521) %>% 
  select(-Region) %>% 
  mutate(Region = "South Pacific") %>% 
  select(1:10,Region,everything())

CP <- Template %>% 
  filter(Region =="TBD") %>% 
  filter(Long <= -98.552521 & Long >= -105.738200) %>% 
  select(-Region) %>% 
  mutate(Region = "Central Pacific") %>% 
  select(1:10,Region,everything())

GC <- Template %>% 
  filter(Region =="TBD") %>% 
  filter(Long <= -105.738200) %>% 
  select(-Region) %>% 
  mutate(Region = "G. Califronia") %>% 
  select(1:10,Region,everything())

TBDS_Clear <- BCC %>% 
  bind_rows(
            WGM,
            SP,
            CP,
            GC)

New_Template <-Template %>% 
  filter(D_ID != 786) %>% 
  bind_rows(TBDS_Clear) %>% 
  arrange(MMID)

CheckMark <- New_Template %>% 
  filter(Region == "TBD")

# write.csv(New_Template,
#           "Template_6.8.csv",
#           row.names = FALSE)

leaflet(GC) %>%
  addTiles(
    urlTemplate = "//{s}.tiles.mapbox.com/v3/jcheng.map-5ebohr46/{z}/{x}/{y}.png",
    attribution = 'Maps by <a href="http://www.mapbox.com/">Mapbox</a>'
  ) %>%
  setView(lng = -90, lat = 18, zoom = 5) %>% 
  addMarkers(
    lng = ~Long,
    lat= ~Lat,
    popup = ""
  )

```


# Locations (INCOMPLETE)

This is going to be fun... I don't think standarization of names is worth the time since we will not do any analysis with it and it still works for the "search" component.

```{r Locations, eval =T, echo =T}

Location_explore <- Template %>% 
  group_by(Location) %>% 
  summarise(n(),
            MMID = paste(MMID,
                         collapse = ";"))

# Multiple
Template$Location <- Template$Location %>% 
  gsub("\\bMultiple Sites\\b", "Multiple Localidades",.) %>% 
  gsub("\\bMultiple Locations\\b", "Multiple Localidades",.) %>% 
  gsub("\\bMultiple Stations\\b", "Multiple Localidades",.) %>% 
  gsub("\\bMultiple States\\b", "Multiple Localidades",.) %>% 
  gsub("\\bMultiple\\b", "Multiple Localidades",.) %>% 
  gsub("\\Area De Proteccion De Flora Y Fauna Cuatrocienegas\\b", "ANP Cuatrocienegas",.) %>% 
  gsub("\\Area De Proteccion De Flora Y Fauna Laguna De Terminos\\b", "ANP Laguna de Terminos",.) %>% 
  gsub("\\Area De Proteccion De Flora Y Fauna Yum Balam\\b", "ANP Yum Balam",.) %>% 
  gsub("\\Area Natural Protegida Estatal Presa De Silva Y Zonas Aledanas\\b", "ANP Presa de Silva",.) %>% 
  gsub("\\Areas De Proteccion De Flora Y Fauna De Naha Y Metzabok\\b", "ANP Naha Y Metzabok",.) %>% 
  gsub("\\Archipielago\\b", "Revillagigedo",.) %>% 
  gsub(" De Juarez", "",.) %>% 
  gsub(" De Alvarez", "",.) %>% 
  gsub(" De Navarro", "",.) %>% 
  gsub(" De Terrazas", "",.) %>% 
  gsub(" De Perez Figueroa", "",.) %>% 
  gsub(" De Iturbide", "",.) %>% 
  gsub(" De Mercado", "",.) %>% 
  gsub(" De Guerrero", "",.) %>% 
  gsub(" De Montes", "",.) %>% 
  gsub("Bahia Concepcion ", "Bahia Concepcion",.) %>% 
  gsub(", Son", "",.) %>% 
  gsub("Bahia Kino", "Bahia De Kino",.) %>% 
  gsub("\\bBahia De\\b", "Bahia",.) %>% 
  gsub("\\bBahia\\b", "Bahia De ",.) %>% 
  gsub("Sebasti_N", "Sebastian",.) %>% 
  gsub("Baja California Norte", "Baja California",.) %>% 
  gsub("Baja California, Bahia Tortugas", "Bahia De Tortugas",.) %>% 
  gsub("Baja California; Embarcaciones; Principales Pesquerias; Altura; Estado; Pesca; Camaron", "Baja California",.) %>% 
  gsub(",.*", "",.) %>% 
  gsub("Campeche Bank, Alacranes Reef", "Arrecife De Alacranes",.) %>% 
  gsub("Kenedy", "Kennedy",.)
    
# Second rownd

Template$Location <- Template$Location %>% 
  gsub("Baja California Sur Sur", "Baja California Sur",.) %>% 
  gsub("Baja California Sur Sur", "Baja California Sur",.)


  
Locations <- Template %>% 
  filter(Location == "Apulco")
View(Locations)


# Missing location 

# Dataset of Mexico Politico and Municipios

Mexico_Politico <- read.csv("~/Documents/Github/Meta_Data_Mexico/Parallel Analysis/Data/Mexico_Politico_Municipios.csv")

Template$Location <- Template$Location %>% 
  gsub(" -D.*", "",.)

# INEGI

INEGI <- Template %>% 
  filter(Author == "INEGI") %>%  
  left_join(Mexico_Politico,
            by="Location") %>% 
  select(-Entidad.Federativa)

INEGI$Area <- INEGI$Area_M
INEGI$Region <- INEGI$Region_M

INEGI_Fin <- INEGI %>% 
  select(-Area_M,
         -Region_M
  )


## Put INEGI back in the Template

# Solve the repetition problem of the left join created by "Municipios" with the same name in different parts of the country (E.g. Loreto BCS and Loreto Zacatecas)
Duplicated_INEGI <-INEGI_Fin[duplicated(INEGI_Fin[2]), ] # dropping repeated
Clean_INEGI <-INEGI_Fin[!duplicated(INEGI_Fin[2]), ] # dropping repeated


New_Template <- Template %>% 
  filter(Author != "INEGI") %>% 
  bind_rows(Clean_INEGI) %>% 
  arrange(MMID)

# Listo

#### Explore NA's by Region ####

NA_Region <- New_Template %>% 
  filter(Author == "INEGI") %>% 
  filter(is.na(Region)) %>% 
  group_by(Location) %>% 
  summarise(n())

## Varios problemas con "El, La, Los". Quitar y volver a hacer.... CHECK! 

# Los ultimos cuatro los pongo manual....
write.csv(New_Template,
          "Template_6.3.csv",
          row.names = FALSE)


```


## Years

```{r Time, eval =T, echo =T}

Time <- Template %>% 
  group_by(Location) %>% 
  summarise(n(),
            Min_S = min(Start_Year),
            Max_S = max(Start_Year),
            Min_E = min(End_Year),
            Max_E = max(End_Year)
  )

Time_Explore <- Template %>% 
  filter(End_Year == 2021)

DTP <- Template %>% 
  group_by(Dataset_Title) %>% 
  summarise(
    n(),
    Min = min(Data_Time_Points, na.rm=T),
    Max = max(Data_Time_Points, na.rm=T),
    Mean = mean(Data_Time_Points, na.rm=T)
  )

```

## Unit Type

In this section I worked on the standarization of terms (e.g. Count -> Counts), I also re categorize some of the records to more appropiate categories

```{r Dataset_Title, eval =T, echo =T}

Unit <- Template %>% 
  group_by(Unit_Type) %>% 
  summarise(n())
  
Unit_type <- Template %>% 
  select(MMID,
         Unit_Type)

Unit_type$Unit_Type <- Unit_type$Unit_Type %>% 
  gsub("\\bCount\\b", "Counts",.) %>% 
  gsub("Lenght", "Length",.) %>% 
  gsub("Mapa", "Map",.) %>% 
  gsub("PDF", "Literature",.) %>% 
  gsub("Cover", "",.) %>% 
  gsub("Porcentaje", "Percentage",.) %>% 
  gsub("Teperature", "Temperature",.) %>% 
  gsub("Tons", "Weight",.) %>% 
  gsub("Values", "Value",.) %>% 
  gsub("Videotransect", "Video",.) %>% 
  gsub("Volumen", "Volume",.) %>% 
  gsub(" ", "",.) %>% 
  gsub("\\bC\\b", "Counts",.) %>% 
  gsub("\\bDensity\\b", "Concentration",.) %>% 
  gsub("\\bSize\\b", "Length",.) %>% 
  gsub("\\bUnit\\b", "Literature",.)

data.frame(Uni = unique(Unit_type$Unit_Type)) %>% 
  arrange(Uni)

# Fixing: "Area"

# Fisheries Monitoring Program in La Paz, B.C.S.
Unit_type$Unit_Type[97794:97852] <- "Weight" 
Unit_type$Unit_Type[97853:97970] <- "Currency"
Unit_type$Unit_Type[97971:98029] <- "Other"

# Fixing: "Concentration"

# Bitacora de colecta de pH | Proyecto Vaquita
Unit_type$Unit_Type[33117:33118] <- "pH" 
# Bitacora de colecta de pH | Tehuanos2
Unit_type$Unit_Type[33125:33125] <- "pH" 
# Atlas Climatico Digital de Mexico
Unit_type$Unit_Type[1487:1498] <- "Counts"

# Fixing: "Currency"
# All gut

# Fixing Index
# ESPECIES, EPOCAS Y ZONAS DE VEDA PERMANENTE | Anuario Estadístico
Unit_type$Unit_Type[1842:1947] <- "Time"
# Mapping Ocean Ecosystem Services
Unit_type$Unit_Type[32503:32505] <- "Currency"
Unit_type$Unit_Type[32509:32511] <- "Map"
Unit_type$Unit_Type[32512:32512] <- "Currency"
Unit_type$Unit_Type[32513:32513] <- "Weight"

# Fixing Multiple
Unit_type$Unit_Type[27108:29218] <- "Value"

# Fixing Percentage
Unit_type$Unit_Type[92894:92895] <- "Area"

# Fixing Point
Unit_type$Unit_Type[59007:59187] <- "Index"

# Fixing Pressure and Radiation
# Datos Abiertos MX
Unit_type$Unit_Type[73680:73680] <- "Other"
Unit_type$Unit_Type[73675:73675] <- "Other"


# Fixing Unit
# dataMares
Unit_type$Unit_Type[93052:93172] <- "Counts"
Unit_type$Unit_Type[97295:97296] <- "Other"
Unit_type$Unit_Type[98471:98478] <- "Counts"

# Indicadores Basicos del Desempeno Ambiental - Biodiversidad - Especies
Unit_type$Unit_Type[29805:29805] <- "Index"

# Fixing NA's
Unit_type$Unit_Type[33119:33119] <- "Density"
Unit_type$Unit_Type[62184:62213] <- "Literature"
Unit_type$Unit_Type[88032:88079] <- "Literature"
Unit_type$Unit_Type[88080:88080] <- "Value"


Unit_Explore <- Template %>% 
  # filter(Unit_Type == "Weight") %>% 
  filter(is.na(Unit_Type)) %>% 
  group_by(
    Dataset_Title,
    Compilation_Title
    ) %>% 
  summarise(paste(Short_Title,
                  collapse = ";"),
            Min = min(MMID),
            Max = max(MMID),
            Ref = paste(unique(Reference),
                        collapse = ";")
  )

x <- Template %>%
  # filter(MMID >= 59007 & MMID <= 59187) %>%
  filter(Institution == "UNAM-UAY") %>%
  group_by(Author) %>% 
  summarise(n())
  select(
    MMID,
    Short_Title,
    Dataset_Title,
    Keywords,
    Reference)


data.frame(Uni = unique(Unit_type$Unit_Type)) %>% 
  arrange(Uni)

## Merge New Unit Type with old dataset

New_Template <- Template %>% 
  select(-Unit_Type) %>% 
  left_join(Unit_type,
            by="MMID") %>% 
  select(1:13,Unit_Type,everything())

New_template_Check <- New_Template %>% 
  group_by(Unit_Type) %>% 
  summarise(n())


```

## Temporal_Resolution

Standarization of terms and correction of some records.


```{r Temporal_Resolution, eval =T, echo =T}

Explore_Temporal <- Template %>% 
  group_by(Temporal_Resolution) %>% 
  summarise(n())

TE <- Template %>% 
  select(MMID,Temporal_Resolution)

TE$Temporal_Resolution <- TE$Temporal_Resolution %>% 
  gsub("\\bAnual\\b", "Year",.) %>% 
  gsub("Daily", "Day",.) %>% 
  gsub("hour", "Hour",.) %>% 
  gsub("Hourly", "Hour",.) %>% 
  gsub("Monthly", "Month",.) %>% 
  gsub("Seconds", "Second",.) %>% 
  gsub("Annual", "Year",.) %>% 
  gsub("Minutes", "Minute",.)

data.frame(Uni = unique(TE$Temporal_Resolution)) %>% 
  arrange(Uni)

# Check them out

TE_Explore <- Template %>% 
  filter(Temporal_Resolution == "Semester") %>%
  # filter(is.na(Temporal_Resolution)) %>% 
  group_by(
    Dataset_Title,
    Compilation_Title
    ) %>% 
  summarise(paste(Short_Title,
                  collapse = ";"),
            Min = min(MMID),
            Max = max(MMID),
            Ref = paste(unique(Reference),
                        collapse = ";")
  )

TE$Temporal_Resolution[749:1235] <- "Day"
TE$Temporal_Resolution[27108:29218] <- "NA"

data.frame(Uni = unique(Template$Temporal_Resolution)) %>% 
  arrange(Uni)


# Merge stuff 

New_Template <- Template %>% 
  select(-Temporal_Resolution) %>% 
  left_join(TE,
            by="MMID") %>% 
  select(1:14,Temporal_Resolution,everything())

New_template_Check <- New_Template %>% 
  group_by(Temporal_Resolution) %>% 
  summarise(n())


```

## Spatial resolution (MISSING)

```{r Spatial_Resolution, eval =T, echo =T}


Explore_Spatial <- Template %>% 
  group_by(Spatial_Resolution) %>% 
  summarise(n())



SR <- Template %>% 
  select(MMID,Spatial_Resolution)

SR$Spatial_Resolution <- SR$Spatial_Resolution %>% 
  gsub("\\bGeoreference\\b", "Georeferenced",.) %>% 
  gsub("Atlantic", "Area",.) %>% 
  gsub("Gulf of Mexico", "Region",.) %>% 
  gsub("Nacional", "National",.) %>% 
  gsub("North Pacific", "Region",.) %>% 
  gsub("Pacific", "Area",.) %>% 
  gsub("Pacifico", "Area",.) %>% 
  gsub("Regional", "Region",.) %>% 
  gsub("Zone", "Location",.) %>% 
  gsub("Oceanografia del golfo", "Region",.) %>% 
  gsub("Areao", "Area",.)

SR_Explore <- Template %>% 
  filter(Spatial_Resolution == "Zone") %>%
  # filter(is.na(Spatial_Resolution)) %>% 
  group_by(
    Dataset_Title,
    Compilation_Title
    ) %>% 
  summarise(paste(Short_Title,
                  collapse = ";"),
            Min = min(MMID),
            Max = max(MMID),
            Ref = paste(unique(Reference),
                        collapse = ";")
  )

data.frame(Uni = unique(SR$Spatial_Resolution)) %>% 
  arrange(Uni)

# One by One 

SE_Explore <- Template %>% 
  filter(Spatial_Resolution == "Area") %>%
  # filter(is.na(Temporal_Resolution)) %>% 
  group_by(
    Dataset_Title,
    Compilation_Title
    ) %>% 
  summarise(paste(Short_Title,
                  collapse = ";"),
            Min = min(MMID),
            Max = max(MMID),
            Area = paste(unique(Area),
                        collapse = ";"),
            Region = paste(unique(Region),
                        collapse = ";"),
            Loc = paste(unique(Location),
                        collapse = ";")
  )

data.frame(Uni = unique(Template$Spatial_Resolution)) %>% 
  arrange(Uni)




```

## Dataset_Title and Compilation_Title

I've changed all the datasets that Excel miss label 2013...2014...2015...2056...20nn. Did the same for Compilation Titles. 

```{r Dataset_Title, eval =T, echo =T}

Dataset <- Template %>% 
  group_by(
           Compilation_Title) %>% 
  summarise(
            Min = min(MMID),
            Max = max(MMID),
            Check = Max-Min+1,
            n()
  )

Template$Dataset_Title[29444:29534] <- "Aquaculture Production (Quantities and values) 1950-2014"
Template$Dataset_Title[29534:29761] <- "Fisheries Commodities Production and Trade 1976-2013"
Template$Dataset_Title[1548:1579] <- "Balanza comercial por principales productos pesqueros, 1989 - 2013"
Template$Dataset_Title[31659:32038] <- "Base del Golfo de California 2016"
# Template$Dataset_Title[68681:73783] <- "Lista de sitios de Patrimonio Mundial, Natural o Mixtos en ANP de Mexico 2016"
Template$Dataset_Title[1807:1839] <- "Permisos de Pesca Deportiva-Recreativa Por Litoral, Entidades sin Litoral, Oficina de San Diego, Tipo y Categoria (Ley Federal de Derechos)"
Template$Dataset_Title[32515:32548] <- "Permisos de Pesca Deportiva-Recreativa Por Litoral, Entidades sin Litoral, Oficina de San Diego, Tipo y Categoria (Ley Federal de Derechos)"
Template$Dataset_Title[74001:74063] <- "Tabla de solicitudes ingresadas para artes de pesca por municipio 2011"
Template$Compilation_Title[10:10] <- "dataMares"

# Datamares

DataMares <- Template %>% 
  filter(Compilation_Title == "dataMares") %>% 
  group_by(Dataset_Title) %>% 
  summarise(n())

Template$Dataset_Title <- Template$Dataset_Title %>% 
  gsub("em_hu_monitoreo_arrecifal_CORALES","Conservacion de Arrecifes de Coral en el Pacifico Mexicano",.) %>% 
  gsub("em_hu_monitoreo_arrecifal_INVERTEBRADOS","Conservacion de Arrecifes de Coral en el Pacifico Mexicano",.) %>% 
  gsub("em_hu_monitoreo_arrecifal_PECES","Conservacion de Arrecifes de Coral en el Pacifico Mexicano",.) %>% 
  gsub("em_po_diversidad_funcional.xlsx","Assessing the role of fish in kelp forests and rocky reefs",.) %>% 
  gsub("em_po_kelp.xslx","Counting Fish in the Kelp Forests of Baja California",.)

Dataset_Explore <- Template %>% 
  # filter(Compilation_Title == "Historial de Permisos de Pesca Deportiva")
  filter(str_detect(Dataset_Title, 'Tabla de solicitudes ingresadas para artes de pesca por municipio'))
  # filter(Dataset_Title == "Lista de sitios de Patrimonio Mundial, Natural o Mixtos en ANP de Mexico 2016")



#### Checking....

Check <- Template %>% 
  filter(MMID >= 1540 & MMID <= 1580)

# all es gut! 

Template$Dataset_Title <-Template$Dataset_Title %>% 
  gsub("Predio de Filete ","Precio de Filete ",.)

```



## Publication year

Just fixed some classic Excel mistake of 2016,2017...20nn.

```{r Pubication_Year, eval =T, echo =T}

Exploring <- Template %>% 
  group_by(Publication_Year) %>% 
  summarise(n())

Wrong_Publi <- Template %>% 
  filter(Publication_Year >= 2018) %>% 
  select(MMID,
         Short_Title,
         End_Year,
         Dataset_Title,
         Compilation_Title,
         Publication_Year)

Template$Publication_Year[1494:1510] <- 2012
Template$Publication_Year[33749:34015] <- 2017
Template$Publication_Year[64611:66832] <- 2017

Template %>% 
  filter(Compilation_Title == "Diversity of benthic diatoms in the Guerrero Negro Lagoon (El Vizcaino Biosfere Reserve), Baja California Peninsula, Mexico")


```

## Reference

Fixed most of Datos Abiertos MX links that were not functional

```{r Reference, eval =T, echo =T}

Exploring_Ref <- Template %>% 
  group_by(Reference) %>% 
  summarise(n())

Wrong_ <- Template %>% 
  filter(Publication_Year >= 2018) %>% 
  select(MMID,
         Short_Title,
         End_Year,
         Dataset_Title,
         Compilation_Title,
         Publication_Year)

Template$Reference[59744:59751] <- "doi:10.5063/AA/afleishman.6.1"
Template$Reference[59722:59741] <- "doi:10.6085/AA/pisco_intertidal.53.7"

#GobMX 

Template$Reference <- gsub(
  "/resource/.*",
  "",
  Template$Reference
)

Template %>% 
  filter(Reference == "https://datos.gob.mx/busca/dataset/indicadores-basicos-del-desempeno-ambiental--biodiversidad--especies")

Template %>% 
  filter(Compilation_Title == "Datos Abiertos MX") %>% 
  group_by(Reference) %>% 
  summarise(n())

```


## Institution Type

Institution type represents the type o institution where THE DATA IS FOUND and does not necessarly represents who collected the data

- Standarization of categories
- Making sure they make sense

```{r Institution_Type, eval = T, echo = F}

unique(Template$Institution_Type)

InstExpo <- Template %>%
  group_by(Institution_Type) %>% 
  summarise(n())

# First we standarize everything #
Explore_IT <- Template %>% 
  filter(Institution_Type == "<NA>")

Template$Institution_Type[87177:87182] <- "ACA"

Template$Institution_Type <- gsub(
  "Int",
  "INT",
  Template$Institution_Type
)

# And now lets see if it makes sensce... 


Institution_Type <- Template %>% 
  select(MMID,
         Author,
         Institution,
         Compilation_Title,
         Institution_Type)

InstsExpo <- Template %>%
  group_by(Institution,
           Institution_Type,
           Compilation_Title) %>% 
  summarise(n(),
            MIN = min(MMID),
            MAX = max (MMID))


Template$Institution_Type[62214:63213] <- "ACA" #GBIF-CONABIO
Template$Institution_Type[29235:29236] <- "GOV" #INAPESCA/ECOPATH
Template$Institution_Type[59742:59751] <- "INT" #KNB
Template$Institution_Type[59658:59691] <- "INT" #KNB
Template$Institution_Type[1511:1511] <- "INT" #OBIS
Template$Institution_Type[29229] <- "INT" #Southeast Fisheries Science Center
Template$Institution_Type[29256:29268] <- "INT" #Southeast Fisheries Science Center
Template$Institution_Type[40415:41262] <- "ACA" # UNIMAR
Template$Institution_Type[29219:29255] <- "INT" # EcoBase
Template$Institution_Type[59626] <- "GOV" # Datos Abierto MX
Template$Institution_Type[68467:69465] <- "GOV" # Datos Abierto MX
Template$Institution_Type[73638:73682] <- "GOV" # Datos Abierto MX | CIBNOR
Template$Institution_Type[41263:42262] <- "INT" # OBIS
Template$Institution_Type[27018:27107] <- "INT" # FERU

Template$Research_Fund[88081:110971] <- "Unknown" # dataMares

Template %>% 
  filter(Compilation_Title == "dataMares")


# Check them ALL out #
# ACA check
# NGO check
# GOV check
# INT check
# IGO check

InstExpo <- Template %>%
  group_by(Institution_Type) %>% 
  summarise(n())

Inst_Tye <- Template %>%
  filter(Institution_Type == "IGO") %>% 
  group_by(
    Author,
    Institution,
    Compilation_Title
           ) %>% 
  summarise(n())


```


## Research Fund

Research fund represents the type of funding that the proyect had, in case of uncertanty funding is linked to the repository where data lives...

- Standarization of categories
- Making sure they make sense

```{r Research_Fund, eval = T, echo = F}

ResearchFund <- Template %>%
  group_by(Research_Fund) %>% 
  summarise(n())

# Do they Make sense? 

# ACA_F check 
# GOV_F check
# IGO_F check (Obis in Excel from IGO_F to INT_F)
# Int_F check
# NGO_F check
# Private_F check
# Unknown check

MF_Check <- Template %>%
  filter(Research_Fund == "Unknown") %>% 
  group_by(
    Author,
    Institution,
    Compilation_Title
           ) %>% 
  summarise(n())

EcoBase <- Template %>% 
  filter(Compilation_Title == "OBIS Data for Mexico")


Template$Research_Fund[29219:29255] <- "Unknown" # EcoBase
Template$Research_Fund[27018:27107] <- "Int_F" # EcoBase
Template$Research_Fund[29256:29268] <- "Int_F" # Feru
Template$Research_Fund[29269:29761] <- "IGO_F" # FAO | FishStatJ



```

# Research Field

```{r Research_Field, eval = T, echo = F}

ResearchField <- Template %>%
  group_by(Research_Field) %>% 
  summarise(n())

# Do they Make sense? 

# ACA_F check 
# GOV_F check
# IGO_F check (Obis in Excel from IGO_F to INT_F)
# Int_F check
# NGO_F check
# Private_F check
# Unknown check

RF_Check <- Template %>%
  filter(Research_Field == "Aquaculture") %>% 
  group_by(
    Author,
    Institution,
    Dataset_Title,
    Compilation_Title
           ) %>% 
  summarise(n(),
            Titulos = paste(unique(Short_Title),
                            collapse = "")
            )

EcoBase <- Template %>% 
  filter(Dataset_Title == "Lista de sitios de Patrimonio Mundial, Natural o Mixtos en ANP de Mexico 2016")


Template$Research_Field[68771:29255] <- "Unknown" # EcoBase
Template$Research_Field[27018:27107] <- "Int_F" # EcoBase
Template$Research_Field[29256:29268] <- "Int_F" # Feru
Template$Research_Field[29269:29761] <- "IGO_F" # FAO | FishStatJ


```


# Social Ecological Interactions

What type of social-ecological interaction is this data an indicator for?

- Benefit (Catch or Landed value)
- State (Stock assessment or Habitat area)
- Pressure (Fishing effort) 
- Response (CONAPESCA budget or Protected area coverage)

- Standarizarion of terminology
- Checking things make sense 

```{r SE, eval = T, echo = F}

SE_Explore <- Template %>%
  group_by(SE_Interaction) %>% 
  summarise(n())

# Spellcheck

Template$SE_Interaction <-Template$SE_Interaction %>% 
  gsub("Respond","Response",.) %>% 
  gsub("Status","State",.) %>% 
  gsub("Benefits","Benefit",.)

# Review each one of them...

# Benefit
# Pressure
# Response
# State

SE_Check <- Template %>%
  # filter(SE_Interaction == "Benefit") %>%
  group_by(
    Author,
    Institution,
    Dataset_Title,
    Compilation_Title
           ) %>% 
  summarise(
            SE_Inter = paste(unique(SE_Interaction),
                            collapse = "; "),
            min = min(MMID),
            max = max(MMID)
            ) %>% 
  select(1:3,SE_Inter,everything())

Template %>%
  # filter(MMID == 86502) %>% 
  filter(MMID >= 80728 & MMID <= 80781)

# Genero? Peso viserado? 

Template$SE_Interaction[73573:73584] <- "State"
Template$SE_Interaction[73585:73608] <- "State"


```


Modificar en template: 

"Programa de innovacion cienti fica como herramienta para el fortalecimiento de la actividad pesquera sostenible en Bahi a Magdalena, B.C.S"

"Registros acuicultura Mex 2012-2017"

```{r Science, eval = T, echo = F}
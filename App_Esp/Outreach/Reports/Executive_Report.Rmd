---
title: "Base de metadatos de la investigación marina en México"
author: ''
date: "20 Junio, 2017"
output:
  pdf_document:
    fig_caption: yes
    fig_height: 2
    fig_width: 3
  word_document: default
---

```{r packages and data, eval=T, echo=F, warning=F, message=F}

library(data.table)
library(knitr)
library(kableExtra)
library(dplyr)
library(dygraphs)
library(ggplot2)


Template <- fread("/Users/jpalacios/Documents/Github/Meta_Data_Mexico/App_Esp/Template.csv",
                  colClasses = c(Location = 'character',
                                 Notes = 'character',
                                 Data_Uncertanty ='character')
)


# Needed for Historic reconstruction
Pedroche<- fread("./App_Eng/Pedroche_Hist.csv")

```

```{r Numbers, eval=T, echo=F, warning=F, message=F}

# Number of entries ####
Number_entries <- Template %>%
  filter(MMID != "na")

N_entries <- paste(Number_entries$MMID[length(Number_entries$MMID)])

# Number of Data Points ####
N_dp <- paste(
  round(sum(Number_entries$Data_Time_Points,na.rm=T)/1000)
)

# Number of Repositories ####
z<- Template %>%
  group_by(Compilation_Title) %>%
  summarise(sum(Data_Time_Points)) %>%
  select(-2) %>%
  filter(!is.na(Compilation_Title)) %>%
  mutate(z = 1)

N_rep <- paste(sum(z$z))

#### Inicio y fin ##

Template2 <- Template %>% 
  filter(Start_Year >= 1700)

Y_Inicio <- min(Template2$Start_Year, na.rm = T)

#### Resultados mas especificos ####

Disciplina <- Template %>% 
  group_by(Research_Field) %>% 
  summarise(Registros=n(),
            Datos = sum(Data_Time_Points,
                        na.rm =T),
            Inicio = min(Start_Year,
                         na.rm =T),
            Fin = max(Start_Year,
                      na.rm =T)) %>% 
  arrange(desc(Registros))

Research_Field_T <-  kable(Disciplina,
                           caption = "Resúmen de información contenida en los metadatos por categoría de investigación")

### Especies con más datos ###

Filtrado = c("Multiple Species", "Multiple Especies", "TBD")

Especies <- Template %>% 
  filter(!is.na(Subject_name)) %>% 
  filter(!Subject_name %in% Filtrado) %>% 
  group_by(Subject_name) %>% 
  summarize(Registros=n(),
            Datos = sum(Data_Time_Points,
                        na.rm =T),
            Inicio = min(Start_Year,
                         na.rm =T),
            Fin = max(Start_Year,
                      na.rm =T)) %>% 
  arrange(desc(Registros))

### Estados con más datos ###

Filtrado = c("Multiple locations", "Multiple", "TBD", "Multiple Stations")

Localidades <- Template %>% 
  filter(!is.na(Location)) %>% 
  filter(!Location %in% Filtrado) %>% 
  group_by(Location) %>% 
  summarize(Registros=n(),
            Datos = sum(Data_Time_Points,
                        na.rm =T),
            Inicio = min(Start_Year,
                         na.rm =T),
            Fin = max(Start_Year,
                      na.rm =T)) %>% 
  arrange(desc(Registros))

```

### Investigadores Principales:
-	Dr. Andrés Cisneros-Montemayor, Institute of Oceans and Fisheries, University of British Columbia
-	Dr. Francisco Arreguín-Sánchez, Centro Interdisciplinario de Ciencias Marinas, Instituto Politécnico Nacional
-	MSc. Juliano Palacios-Abrantes, Institute of Oceans and Fisheries, University of British Columbia
-	Dr. Laura Rodríguez, Environmental Defense Fund México
- Dr. Miguel Ángel Cisneros-Mata, Centro Regional de Investigación Pesquera, Guaymas, Instituto nacional de Pesca
-	Dr. William Cheung, Institute of Oceans and Fisheries, University of British Columbia


#Resumen ejecutivo

La investigación y manejo de los recursos marinos es cada vez más dependiente de diversos
indicadores biológicos, ecológicos, económicos y sociales. En México, dichos indicadores
pueden existir, pero no siempre están disponibles al público o su existencia no es conocida.
El estar al tanto de qué datos existen para diversos temas o regiones es un enorme paso para
incrementar la colaboración e investigación que apoya la toma de decisión en México. Una
base de metadatos compuesta por información relacionada a la ecología, sociología y
economía, enfocada a los sistemas marinos en México, facilitará el uso eficiente de la
información existente al mismo tiempo que estimulará la colaboración entre distintos
sectores interesados en el desarrollo marino del país. Dicha base de metadatos estará
compuesta por información sobre datos existentes, en lugar de contener los datos en sí. El
presente proyecto tiene como objetivo crear una base de metadatos sobre datos relacionados
a la investigación marina en México. Así mismo, se pretende identificar información faltante
con el objetivo de informar dónde se debería de enfocar la investigación futura. Finalmente,
se espera que el producto final esté disponible a cualquier persona interesada en la
investigación marina en México. Así, al no estarse colectando datos más información sobre
los mismos, en un marco de creciente interdisciplinariedad, un investigador podría identificar
datos de interés dentro de la base de metadatos, contactar directamente a la persona indicada,
y colaborar en una nueva investigación que informe políticas pertinentes para alguna
comunidad o región. Desde noviembre de 2016 se han creado `r N_entries` registros, colectando información sobre más de `r N_dp` mil datos generados entre `r Y_Inicio` y 2017 (Fig. 1), siendo el océano Pacífico el litoral con más información hasta ahora (Fig 2). Dichos datos provienen de más de `r N_rep` fuentes de libre acceso y publicaciones científicas siendo pesquerías y ecología las disciplinas con más registros (Tabla 1). Si omitimos los registros que contienen múltiples especies, encontramos que `r Especies$Subject_name[1]`  y `r Especies$Subject_name[2]` son los organismos con más registros y las localidades con más registros son `r Localidades$Location[1]` y `r Localidades$Location[2]`. A pesar de tener una respuesta positiva de más de 60 individuos de la comunidad científica y distintas instituciones gubernamentales y no gubernamentales (Tabla 2), aún falta información por recopilar. Dado su extensa expreiencia en manejo de datos, los objectivos institucionales y la gran cantidad de información generada a lo largo de los años, la incorporación de instituciones como INECC y CONABIO se vuelve fundamental para crear una base de metadatos que en verdad refleje la información existente en México. Cuantas más personas e instituciones aporten información a la base de metadatos, mejor se podrá reflejar el estado de la investigación marina en México.

**Nota:** Los datos, gráficas y tablas aquí reportados son preeliminares y de ninguna manera refeljan el estado acutual de la investigación marina en México. Dicho resultado sólo se podrá lograr cuando el proyecto haya logrado capturar una gran parte de los datos producidos en el país.


#Anexo; Imágenes y Tablas

```{r Fig3, echo=F,eval=T,message=F,warning=F, fig.height=3, fig.width=6, fig.cap="Historial de datos capturados en los metadatos. Nota, los datos futuros representan modelos de proyección"}

Pedroche <- Pedroche %>% 
  select(-1)
Hist <- Template %>%
  filter(MMID <=2861) %>%
  select(Start_Year,End_Year) # <- Temporary fix for Brusca and Pedroche data

#Reads Predoche fixed data from the Parallel Analysis

# #Join both datasets and removes NA's
Fin_Plot <- Pedroche %>%
  bind_rows(Hist) %>%
  filter(!is.na(Start_Year))

#### Codigo Andres ####
tdat= na.omit(Fin_Plot[,c("Start_Year","End_Year")]) #Subset columns with 
tdat$Start_Year<- as.numeric(as.character(tdat$Start_Year))
tdat$End_Year<- as.numeric(as.character(tdat$End_Year))
#mean(tdat$Start_Year) #just checking they are number
#mean(tdat$End_Year) #just checking they are number

#start and end year data
years= 1930:2020 #Limit time span considered

#x = tdat[1,1]:tdat[1,2] #First full time series #<- not working for me (J) So this should work as well:
x <- tdat$Start_Year[1]:tdat$End_Year[1] # <- (J)
#It works!

ts= cbind( years, !is.na(match(years, x))==1 ) #Flag years in time series
for(i in 2:dim(tdat)[1]) #Repeat for all data
{
  #x= tdat[i,1] : tdat[i,2]
  x <- tdat$Start_Year[i]:tdat$End_Year[i]
  ts= cbind(ts, !is.na(match(years, x))==1)
}
tssum= cbind(ts[,1], rowSums(ts[,2:dim(ts)[2]]) ) #Sum over years
gtssum <- data.frame(tssum)

ggplot(gtssum, aes(X1, X2)) +
  geom_line() +
  xlab("Año") +
  ylab("Numero de datos")+
  theme_classic()+
  scale_x_discrete(limits =c(seq(1930,2020,10)))

```

```{r Fig1, echo=F,eval=T, fig.height=3, fig.width=6, fig.cap= "Registros por Litoral Mexicano. Nacional se refiere a datos que comprenden 2 o más litorales. Terrestre se refiere a datos en estados sin litoral"}

AreaEsp <- data.frame(c(
  Esp=
    "Atlántico",
  "Terrestre",
  "Nacional",
  "Pacífico"
)
)
colnames(AreaEsp) <- "AreaEsp"

Area <- Template %>%   
  group_by(Area) %>%
  summarise(Value = n()) %>% 
  filter(Area !="TBD") %>% 
  filter(Area !="NA") %>% 
  bind_cols(AreaEsp)



ggplot(data= Area,
       aes(
         x=reorder(AreaEsp, -Value),
         y=Value,
         fill=Area
       )) +
  geom_bar(stat="identity")+
  theme_classic() +
  ylab("Número de Registros")+
  xlab("Area")+
  theme(axis.text.x = element_text(
    size=12),
    axis.text.y = element_text(size = 12),
    legend.position = "none",
    axis.title = element_text(size=14,
                              face="bold")
  )


```

\clearpage

`r Research_Field_T`

```{r Tab1, echo=F,eval=T}

Ta <- Template %>%   
  group_by(Author) %>%
  summarise(Value = sum(Data_Time_Points,na.rm=T)) %>% 
  select(-2) %>% 
  slice(1:30)

Tb <- Template %>% 
  filter(MMID != 604) %>% 
  group_by(Author) %>%
  summarise(Value = sum(Data_Time_Points,na.rm=T)) %>% 
  select(-2) %>% 
  slice(31:60)

Tc <- Template %>%
  group_by(Author) %>%
  summarise(Value = sum(Data_Time_Points,na.rm=T)) %>%
  select(-2) %>%
  slice(41:60)

Tf <- bind_cols(Ta,Tb)


Tab <- kable(Tf,
             caption = "Autores e Institutciones representadas en los metadatos. Nota: No todos los autores o instituciones han sido directamente contactados")

```

`r Tab`
